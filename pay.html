<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earnio Payment</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h1>Earnio</h1>
        <p class="description">Secure payment for registration.<br>Complete your signup.</p>
        <div class="price">KES 100</div>

        <div class="payment-section">
            <button id="simplePayBtn"
                style="background: #22c55e; color: white; padding: 15px; width: 100%; font-size: 18px; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-lock"></i> Pay KES 100 to Register
            </button>
            <p id="statusMsg" style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">Secured by
                Paystack</p>
        </div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>

    <!-- INLINE SCRIPT TO AVOID CACHING ISSUES -->
    <script>
        const btn = document.getElementById('simplePayBtn');
        const statusMsg = document.getElementById('statusMsg');

        function setStatus(msg, color = '#666') {
            statusMsg.innerText = msg;
            statusMsg.style.color = color;
        }

        // 1. Check Auth immediately
        const token = localStorage.getItem('token');
        if (!token) {
            setStatus('Not Logged In. Redirecting...', 'red');
            setTimeout(() => window.location.href = 'login.html', 1500);
            btn.disabled = true;
        }

        // 2. Click Handler
        if (btn) {
            btn.addEventListener('click', async () => {
                setStatus('Initiating Payment...', 'blue');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                try {
                    // Fetch Tx Reference
                    const res = await fetch('http://localhost:3000/pay/initiate', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!res.ok) throw new Error('Server Error: ' + res.status);

                    const data = await res.json();
                    setStatus('Opening Paystack...', 'blue');

                    // Check Library
                    if (typeof PaystackPop === 'undefined') {
                        throw new Error('Paystack Library Failed to Load');
                    }

                    // GENERATE RANDOM REFERENCE CLIENT-SIDE TO RULE OUT BACKEND ISSUES
                    const randomRef = 'TEST_' + Math.floor(Math.random() * 1000000000 + 1);
                    setStatus('Opening Paystack (Ref: ' + randomRef + ')...', 'blue');

                    // Open Popup with HARDCODED TEST KEY
                    const handler = PaystackPop.setup({
                        key: 'pk_test_e61df53001707bcf5afe0fbfa20d361c209311f1',
                        email: 'user@Earnio.com',
                        amount: 10000,
                        currency: 'KES',
                        ref: randomRef, // Client-side Ref
                        callback: function (response) {
                            setStatus('Payment Success! Verifying...', 'green');
                            window.location.href = `/payment-success.html?ref=${response.reference}`;
                        },
                        onClose: function () {
                            setStatus('Payment Canceled by User', 'orange');
                            alert('Transaction Canceled');
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-lock"></i> Pay KES 100 to Register';
                        }
                    });

                    handler.openIframe();

                } catch (err) {
                    console.error(err);
                    setStatus('Error: ' + err.message, 'red');
                    alert('Error: ' + err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-lock"></i> Try Again';
                }
            });
        }
    </script>
</body>

</html>
