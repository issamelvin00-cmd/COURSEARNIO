<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Reader - Earnio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="reader.css">
    <style>
        /* Utility overrides or specific tweaks */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="reader-container">
        <!-- Sticky Header (Progress) -->
        <header class="progress-header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="course-info" id="courseTitleHeader">Loading course...</div>
            </div>

            <div class="global-progress">
                <div class="progress-track">
                    <div class="progress-fill" id="globalProgressFill"></div>
                </div>
                <div class="progress-pct" id="globalProgressPct">0%</div>
            </div>
        </header>

        <div class="reader-main">
            <!-- Sidebar (Chapters) -->
            <aside class="reader-sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <a href="courses.html" class="back-link" style="margin:0;">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                        <button onclick="reader.showCourseResources()"
                            style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;">
                            <i class="fas fa-box-open"></i> Course Resources
                        </button>
                    </div>
                    <h2 class="sidebar-title">Chapters</h2>
                </div>
                <div class="chapter-list" id="chapterList">
                    <!-- Chapters injected here -->
                </div>
            </aside>

            <!-- Main Reading Pane -->
            <main class="reader-content" id="readingPane">
                <div class="content-wrapper" id="contentWrapper">
                    <div style="padding: 40px; text-align: center; color: var(--reader-text-dim);">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // State Management
        class CourseReader {
            constructor() {
                this.courseId = new URLSearchParams(window.location.search).get('id');
                this.token = localStorage.getItem('token');

                if (!this.token) window.location.href = 'login.html';
                if (!this.courseId) window.location.href = 'courses.html';

                this.state = {
                    course: null,
                    chapters: [],
                    currentChapter: null,
                    resources: [], // Chapter resources
                    courseResources: [], // Global resources
                    tasks: [],
                    completedChapters: new Set(), // IDs
                    completedTasks: new Set(), // IDs
                    progress: 0
                };
            }

            async init() {
                try {
                    await Promise.all([
                        this.loadCourseInfo(),
                        this.loadChapters(),
                        this.loadGlobalProgress(),
                        this.loadCourseResources()
                    ]);

                    this.renderSidebar();

                    // Determine which chapter to load
                    const lastChapterId = this.state.lastViewedChapterId;
                    let chapterToLoad = this.state.chapters[0];

                    if (lastChapterId) {
                        const found = this.state.chapters.find(c => c.id === lastChapterId);
                        if (found) chapterToLoad = found;
                    }

                    if (chapterToLoad) {
                        await this.loadChapter(chapterToLoad.id);
                    }
                } catch (err) {
                    console.error('Init failed:', err);
                    document.getElementById('contentWrapper').innerHTML = `
                        <div style="text-align: center; color: #ff4444; padding: 40px;">
                            <h3>Failed to load course</h3>
                            <button onclick="window.location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
                        </div>
                    `;
                }
            }

            async loadCourseInfo() {
                const res = await fetch(`/courses/${this.courseId}`);
                const data = await res.json();
                this.state.course = data;
                document.getElementById('courseTitleHeader').textContent = data.title;
                document.title = `${data.title} - Reader`;
            }

            async loadCourseResources() {
                try {
                    const res = await fetch(`/courses/${this.courseId}/resources`);
                    this.state.courseResources = await res.json();
                } catch (e) { console.error('Failed to load course resources'); }
            }

            async loadChapters() {
                const res = await fetch(`/courses/${this.courseId}/chapters`);
                this.state.chapters = await res.json();
            }

            async loadGlobalProgress() {
                const res = await fetch(`/courses/${this.courseId}/progress`, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });
                const data = await res.json();
                this.state.completedChapters = new Set(data.completed_chapters || []);
                this.state.lastViewedChapterId = data.last_chapter_id;
                this.updateGlobalProgressUI();
            }

            async loadChapter(chapterId) {
                // Update Sidebar Selection
                this.state.currentChapter = this.state.chapters.find(c => c.id === chapterId);
                this.renderSidebar(); // Re-render to show active state

                // Close mobile sidebar
                document.getElementById('sidebar').classList.remove('open');

                // Loading State
                const wrapper = document.getElementById('contentWrapper');
                wrapper.innerHTML = `<div style="padding: 40px; text-align: center; color: var(--reader-text-dim);"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
                window.scrollTo(0, 0);

                try {
                    // Fetch Content, Resources, Tasks in parallel
                    const [contentRes, resourcesRes, tasksRes] = await Promise.all([
                        fetch(`/chapters/${chapterId}`, { headers: { 'Authorization': `Bearer ${this.token}` } }),
                        fetch(`/chapters/${chapterId}/resources`, { headers: { 'Authorization': `Bearer ${this.token}` } }),
                        fetch(`/chapters/${chapterId}/tasks`, { headers: { 'Authorization': `Bearer ${this.token}` } })
                    ]);

                    if (!contentRes.ok) throw new Error('Failed to load chapter content');

                    const contentData = await contentRes.json();
                    this.state.resources = await resourcesRes.json();

                    const tasksData = await tasksRes.json();
                    this.state.tasks = tasksData;

                    // Populate local set of completed tasks for quick lookup
                    this.state.completedTasks = new Set(tasksData.filter(t => t.completed).map(t => t.id));

                    // Update Read Progress (just last viewed)
                    fetch(`/chapters/${chapterId}/progress`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    this.renderContent(contentData);

                } catch (err) {
                    console.error(err);
                    wrapper.innerHTML = `<div style="text-align: center; color: #ff4444;">Error loading chapter.</div>`;
                }
            }

            showCourseResources() {
                this.state.currentChapter = null;
                this.renderSidebar();
                document.getElementById('sidebar').classList.remove('open');

                const wrapper = document.getElementById('contentWrapper');
                const resources = this.state.courseResources;

                wrapper.innerHTML = `
                    <div class="fade-in">
                        <span class="lesson-category">Course Materials</span>
                        <h1 class="lesson-title">All Resources</h1>
                        
                        <div class="lesson-body">
                            <p>Here you can find all the supplemental materials, videos, and tools for this course.</p>
                        </div>

                        <div class="resources-section" style="margin-top: 20px; border: none;">
                            ${resources.length > 0 ? resources.map(r => `
                                <a href="${r.url}" target="_blank" class="resource-card">
                                    <div class="resource-icon">
                                        <i class="fas ${this.getResourceIcon(r.type)}"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${r.title}</div>
                                        <div style="font-size: 0.8rem; color: var(--reader-text-dim);">${(r.type || 'link').toUpperCase()}</div>
                                    </div>
                                    <i class="fas fa-external-link-alt" style="margin-left: auto; color: var(--reader-text-dim);"></i>
                                </a>
                            `).join('') : '<div style="padding: 20px; text-align: center; background: var(--reader-surface); border-radius: 8px;">No general resources available for this course.</div>'}
                        </div>
                    </div>
                `;
            }

            renderSidebar() {
                const list = document.getElementById('chapterList');
                list.innerHTML = this.state.chapters.map((ch, i) => {
                    const isActive = this.state.currentChapter && this.state.currentChapter.id === ch.id;
                    const isCompleted = this.state.completedChapters.has(ch.id);

                    return `
                        <div class="chapter-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" 
                             onclick="reader.loadChapter(${ch.id})">
                            <div class="chapter-status">
                                ${isCompleted ? '<i class="fas fa-check"></i>' : (i + 1)}
                            </div>
                            <div class="chapter-info">
                                <div class="chapter-title">${ch.title}</div>
                                ${ch.category ? `<div class="chapter-meta">${ch.category}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderContent(chapterData) {
                const wrapper = document.getElementById('contentWrapper');

                // Determine Next Chapter
                const currentIndex = this.state.chapters.findIndex(c => c.id === chapterData.id);
                const nextChapter = this.state.chapters[currentIndex + 1];

                const isChapterCompleted = this.state.completedChapters.has(chapterData.id);

                wrapper.innerHTML = `
                    <div class="fade-in">
                        <span class="lesson-category">${chapterData.category || 'Chapter ' + (currentIndex + 1)}</span>
                        <h1 class="lesson-title">${chapterData.title}</h1>
                        
                        <div class="lesson-body">
                            ${chapterData.content_html || '<p>No content available.</p>'}
                        </div>

                        <!-- RESOURCES -->
                        ${this.state.resources.length > 0 ? `
                            <div class="resources-section">
                                <div class="section-label"><i class="fas fa-paperclip"></i> Resources</div>
                                ${this.state.resources.map(r => `
                                    <a href="${r.url}" target="_blank" class="resource-card">
                                        <div class="resource-icon">
                                            <i class="fas ${this.getResourceIcon(r.type)}"></i>
                                        </div>
                                        <div>
                                            <div style="font-weight: 600;">${r.title}</div>
                                            <div style="font-size: 0.8rem; color: var(--reader-text-dim);">${r.type.toUpperCase()}</div>
                                        </div>
                                        <i class="fas fa-external-link-alt" style="margin-left: auto; color: var(--reader-text-dim);"></i>
                                    </a>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- TASKS -->
                        ${this.state.tasks.length > 0 ? `
                            <div class="tasks-section">
                                <div class="section-label"><i class="fas fa-tasks"></i> Chapter Tasks</div>
                                <div id="taskListContainer">
                                    ${this.renderTasksHTML()}
                                </div>
                            </div>
                        ` : ''}

                        <!-- COMPLETION ZONE -->
                        <div class="completion-zone">
                            ${isChapterCompleted ? `
                                <div style="color: var(--reader-accent); margin-bottom: 24px; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Chapter Completed
                                </div>
                            ` : ''}
                            
                            <button class="btn-complete" id="completeBtn" 
                                onclick="reader.completeChapter()" 
                                ${isChapterCompleted ? 'disabled' : (this.state.tasks.length > 0 && this.state.completedTasks.size < this.state.tasks.length ? 'disabled' : '')}>
                                ${isChapterCompleted ? 'Completed' : 'Mark as Complete & Continue'} 
                                ${!isChapterCompleted ? '<i class="fas fa-arrow-right"></i>' : ''}
                            </button>
                        </div>
                    </div>
                `;
            }

            renderTasksHTML() {
                return this.state.tasks.map(task => {
                    const isDone = this.state.completedTasks.has(task.id);
                    return `
                        <div class="task-item ${isDone ? 'completed' : ''}" onclick="reader.toggleTask(${task.id})">
                            <div class="task-checkbox">
                                ${isDone ? '<i class="fas fa-check" style="font-size: 12px;"></i>' : ''}
                            </div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getResourceIcon(type) {
                switch (type) {
                    case 'video': return 'fa-play';
                    case 'tool': return 'fa-tools';
                    case 'document': return 'fa-file-alt';
                    default: return 'fa-link';
                }
            }

            async toggleTask(taskId) {
                // If already done, ignore (or allow toggle off? User request implied strict progression. Let's allow toggle off visually but backend usually only adds. 
                // Wait, logic says "Chapter = completed only if All tasks done".
                // I won't allow toggle OFF once done for simplicity unless required.
                if (this.state.completedTasks.has(taskId)) return;

                // Optimistic UI
                this.state.completedTasks.add(taskId);
                document.getElementById('taskListContainer').innerHTML = this.renderTasksHTML();
                this.updateCompletionButton();

                try {
                    const res = await fetch(`/chapters/${this.state.currentChapter.id}/complete-task`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ taskId })
                    });
                    if (!res.ok) throw new Error('Failed');
                } catch (err) {
                    // Revert on error
                    this.state.completedTasks.delete(taskId);
                    document.getElementById('taskListContainer').innerHTML = this.renderTasksHTML();
                    this.updateCompletionButton();
                    alert('Failed to update task. Check connection.');
                }
            }

            updateCompletionButton() {
                const btn = document.getElementById('completeBtn');
                const allDone = this.state.tasks.every(t => this.state.completedTasks.has(t.id));
                const alreadyCompleted = this.state.completedChapters.has(this.state.currentChapter.id);

                if (alreadyCompleted) {
                    btn.disabled = true;
                    btn.textContent = 'Completed';
                } else if (allDone) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            }

            async completeChapter() {
                const btn = document.getElementById('completeBtn');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                btn.disabled = true;

                try {
                    const res = await fetch(`/chapters/${this.state.currentChapter.id}/complete`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    const data = await res.json();

                    if (data.error) {
                        alert(data.error);
                        this.updateCompletionButton();
                        return;
                    }

                    // Success
                    this.state.completedChapters.add(this.state.currentChapter.id);
                    this.updateGlobalProgressUI();
                    this.renderSidebar(); // Show checkmark in sidebar

                    // Move to next chapter if exists
                    const currentIndex = this.state.chapters.findIndex(c => c.id === this.state.currentChapter.id);
                    if (currentIndex < this.state.chapters.length - 1) {
                        // Small delay for visual feedback
                        setTimeout(() => {
                            this.loadChapter(this.state.chapters[currentIndex + 1].id);
                        }, 500);
                    } else {
                        btn.innerHTML = 'Course Completed! ðŸŽ‰';
                        btn.style.background = '#10B981';
                        btn.style.color = 'white';
                    }

                } catch (err) {
                    console.error(err);
                    alert('Error completing chapter');
                    this.updateCompletionButton();
                }
            }

            updateGlobalProgressUI() {
                const total = this.state.chapters.length;
                const completed = this.state.completedChapters.size;
                const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

                document.getElementById('globalProgressFill').style.width = `${pct}%`;
                document.getElementById('globalProgressPct').textContent = `${pct}%`;
            }
        }

        // Global functions for UI events
        let reader;
        window.addEventListener('DOMContentLoaded', () => {
            reader = new CourseReader();
            reader.init();
        });

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
    </script>
</body>

</html>