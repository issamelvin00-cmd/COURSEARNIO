# Supabase Setup Guide

This guide will walk you through setting up Supabase for your application with authentication, database storage, and Row Level Security.

## Prerequisites

- Node.js installed
- A Supabase account (sign up at [supabase.com](https://supabase.com))

## Step 1: Create a Supabase Project

1. Go to [https://supabase.com](https://supabase.com)
2. Click "Start your project" or "New Project"
3. Fill in the project details:
   - **Name**: Choose a name for your project (e.g., "maoil-production")
   - **Database Password**: Choose a strong password (save this!)
   - **Region**: Choose the region closest to your users
4. Click "Create new project" and wait for it to initialize (~2 minutes)

## Step 2: Get Your API Keys

1. Once your project is ready, go to **Settings** (gear icon in sidebar)
2. Click on **API** in the settings menu
3. You'll see three important values:
   - **Project URL**: Something like `https://xxxxx.supabase.co`
   - **anon public** key: A long JWT token (safe for browser use)
   - **service_role** key: Another JWT token (KEEP THIS SECRET!)

## Step 3: Configure Environment Variables

1. In your project folder, you'll find a file called `.env.example`
2. **Copy** this file and rename it to `.env.local`:
   ```bash
   copy .env.example .env.local
   ```
3. Open `.env.local` and fill in your Supabase credentials:
   ```env
   SUPABASE_URL=https://xxxxx.supabase.co
   SUPABASE_ANON_KEY=your_anon_key_here
   SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
   ```
4. Keep your existing PayStack and other configuration

## Step 4: Set Up the Database

1. In your Supabase dashboard, click on **SQL Editor** (in the sidebar)
2. Click "New query"
3. Open the file `supabase/schema.sql` from your project folder
4. **Copy the entire contents** of that file
5. **Paste** it into the SQL Editor in Supabase
6. Click **Run** (or press Ctrl+Enter)
7. Wait for it to complete - you should see "Success. No rows returned"

### Verify Database Setup

8. Click on **Table Editor** in the sidebar
9. You should now see all these tables:
   - profiles
   - wallets
   - transactions
   - referrals
   - withdrawals
   - task_logs
   - courses
   - lessons
   - course_purchases
   - lesson_progress

10. Click on any table and then click the **shield icon** (RLS) - it should show "Row Level Security is enabled"

## Step 5: Install Dependencies

The Supabase dependency should already be installed. If not, run:

```bash
npm install @supabase/supabase-js
```

## Step 6: Update Your Server

> **Important**: The `server.js` file needs to be migrated to use Supabase. This will be done in the next step of the integration process.

## Step 7: Test the Connection

Create a simple test script to verify everything is working:

1. Create a file called `test-supabase.js` in your project root
2. Add this code:

```javascript
require('dotenv').config({ path: '.env.local' });
const { supabase, supabaseAdmin } = require('./lib/supabase');

async function testConnection() {
    console.log('Testing Supabase connection...');
    
    // Test 1: Check if client initializes
    console.log('✓ Supabase client initialized');
    
    // Test 2: Try to query profiles table
    const { data, error } = await supabaseAdmin
        .from('profiles')
        .select('*')
        .limit(1);
    
    if (error) {
        console.error('✗ Database query failed:', error.message);
        return;
    }
    
    console.log('✓ Database connection working');
    console.log('✓ All systems ready!');
}

testConnection().catch(console.error);
```

3. Run it:
```bash
node test-supabase.js
```

You should see:
```
✓ Supabase client initialized
✓ Database connection working
✓ All systems ready!
```

## Important Notes

### Authentication Changes

- **Old system**: Used JWT tokens generated by your server
- **New system**: Uses Supabase Auth (JWT tokens from Supabase)
- **Impact**: Existing users will need to sign up again (or migrate)

### Database Migration

If you have existing data in SQLite:

1. You can use the migration script (to be created)
2. Or start fresh with no data
3. **Note**: The first user to sign up will automatically become an admin

### Row Level Security (RLS)

RLS is now enabled on all tables. This means:

- Users can only see their own data by default
- Admins have special policies to see all data
- Database-level security prevents unauthorized access
- No need for manual permission checks in most cases

### Making Users Admin

To promote a user to admin:

1. Go to Supabase Dashboard → SQL Editor
2. Run this query:
```sql
UPDATE profiles 
SET is_admin = TRUE 
WHERE email = 'admin@example.com';
```

## Next Steps

1. ✅ Set up Supabase project
2. ✅ Configure environment variables
3. ✅ Run database schema
4. ⏳ Migrate server.js to use Supabase
5. ⏳ Test all endpoints
6. ⏳ Deploy

## Troubleshooting

### "Missing Supabase environment variables"

- Make sure you renamed `.env.example` to `.env.local`
- Check that all three Supabase variables are filled in
- Restart your server after adding environment variables

### "Invalid API key"

- Double-check you copied the entire key from Supabase
- Make sure there are no extra spaces
- Verify you're looking at the correct project in Supabase

### "Database query failed"

- Make sure you ran the schema.sql file completely
- Check the SQL Editor for any errors
- Verify RLS is enabled on tables

### "Cannot connect to Supabase"

- Check your internet connection
- Verify the SUPABASE_URL is correct
- Make sure your Supabase project is not paused

## Support

- **Supabase Docs**: [https://supabase.com/docs](https://supabase.com/docs)
- **Supabase Discord**: [https://discord.supabase.com](https://discord.supabase.com)
